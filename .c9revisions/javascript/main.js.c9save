{"ts":1353090600631,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"  dojo.provide(\"utilities.layout\");\r\n\r\n  dojo.require(\"esri.map\");\r\n  dojo.require(\"esri.layout\");\r\n  dojo.require(\"esri.widgets\");\r\n  dojo.require(\"esri.arcgis.utils\");\r\n  dojo.requireLocalization(\"esriTemplate\",\"template\");\r\n\r\n  //Jquery Layout\r\n    $(document).ready(function(e) {\r\n      $(\"#legendToggle\").click(function(){\r\n    \tif ($(\"#legendDiv\").css('display')=='none'){\r\n\t\t  $(\"#legTogText\").html(i18n.viewer.legToggle.up);\r\n\t\t}\r\n\t\telse{\r\n\t\t  $(\"#legTogText\").html(i18n.viewer.legToggle.down);\r\n\t\t}\r\n\t\t$(\"#legendDiv\").slideToggle();\r\n\t  });\r\n    });\r\n\r\n  utilities.layout = {};\r\n  dojo.mixin(utilities.layout,{\r\n\r\n      map:null,\r\n      urlObject:null,\r\n      i18n:null,\r\n\r\n      initMap:function() {\r\n       utilities.layout.patchID();\r\n\r\n       //get the localization strings\r\n  \t   i18n = dojo.i18n.getLocalization(\"esriTemplate\",\"template\");\r\n\r\n\t   dojo.byId('loading').innerHTML = i18n.viewer.loading.message;\r\n\t   dojo.byId('legTogText').innerHTML = i18n.viewer.legToggle.down;\r\n\r\n       if(configOptions.geometryserviceurl && location.protocol === \"https:\"){\r\n         configOptions.geometryserviceurl = configOptions.geometryserviceurl.replace('http:','https:');\r\n       }\r\n       esri.config.defaults.geometryService = new esri.tasks.GeometryService(configOptions.geometryserviceurl);\r\n\r\n       if(!configOptions.sharingurl){\r\n         configOptions.sharingurl = location.protocol + '//' + location.host + \"/sharing/content/items\";\r\n       }\r\n       esri.arcgis.utils.arcgisUrl = configOptions.sharingurl;\r\n\r\n       if(!configOptions.proxyurl){\r\n         configOptions.proxyurl = location.protocol + '//' + location.host + \"/sharing/proxy\";\r\n       }\r\n\r\n       esri.config.defaults.io.proxyUrl =  configOptions.proxyurl;\r\n\r\n       esri.config.defaults.io.alwaysUseProxy = false;\r\n\r\n       urlObject = esri.urlToObject(document.location.href);\r\n       urlObject.query = urlObject.query || {};\r\n\r\n       if(urlObject.query.title){\r\n         configOptions.title = urlObject.query.title;\r\n       }\r\n       if(urlObject.query.subtitle){\r\n         configOptions.subtitle = urlObject.query.subtitle;\r\n       }\r\n\t   if(urlObject.query.legend){\r\n         configOptions.legend = urlObject.query.legend;\r\n       }\r\n       if(urlObject.query.webmap){\r\n         configOptions.webmap = urlObject.query.webmap;\r\n       }\r\n       if(urlObject.query.bingMapsKey){\r\n         configOptions.bingmapskey = urlObject.query.bingMapsKey;\r\n       }\r\n\r\n\t   \t   //is an appid specified - if so read json from there\r\n\t  if(configOptions.appid || (urlObject.query && urlObject.query.appid)){\r\n\t\tvar appid = configOptions.appid || urlObject.query.appid;\r\n\t\tvar requestHandle = esri.request({\r\n\t\t  url: configOptions.sharingurl + \"/\" + appid + \"/data\",\r\n\t\t  content: {f:\"json\"},\r\n\t\t  callbackParamName:\"callback\",\r\n\t\t  load: function(response){\r\n               if(response.values.webmap !== undefined){configOptions.webmap = response.values.webmap;}\r\n\t\t\t   if(response.values.title !== undefined){configOptions.title = response.values.title;}\r\n\t\t\t   if(response.values.subtitle !== undefined){configOptions.subtitle = response.values.subtitle;}\r\n\t\t\t   if(response.values.legend !== undefined){configOptions.legend = response.values.legend;}\r\n\r\n\t\t\t   utilities.layout.createMap();\r\n\t\t  },\r\n\t\t  error: function(response){\r\n\t\t\tvar e = response.message;\r\n\t\t   alert(i18n.viewer.errors.createMap +  response.message);\r\n\t\t  }\r\n\t\t});\r\n\t\t }else{\r\n\t\t\tutilities.layout.createMap();\r\n\t\t }\r\n\t },\r\n\r\n     createMap: function(){\r\n\r\n       if (configOptions.legend === \"false\" || configOptions.legend === false){\r\n           $(\"#legendCon\").hide();\r\n\t   }\r\n\r\n\t   var mapDeferred = esri.arcgis.utils.createMap(configOptions.webmap, \"map\", {\r\n         mapOptions: {\r\n           slider: true,\r\n           sliderStyle:\"small\",\r\n           nav: false,\r\n           wrapAround180:true\r\n         },\r\n         ignorePopups:false,\r\n         bingMapsKey: configOptions.bingmapskey\r\n       });\r\n\r\n       mapDeferred.addCallback(function (response) {\r\n\r\n\t\t document.title = configOptions.title|| response.itemInfo.item.title || \"\";\r\n         dojo.byId(\"title\").innerHTML = configOptions.title ||response.itemInfo.item.title || \"\";\r\n         dojo.byId(\"subtitle\").innerHTML = configOptions.subtitle|| response.itemInfo.item.snippet || \"\";\r\n\r\n         map = response.map;\r\n\r\n\t\t dojo.connect(map,\"onUpdateEnd\",utilities.layout.hideLoader);\r\n\r\n         var layers = response.itemInfo.itemData.operationalLayers;\r\n         if(map.loaded){\r\n           utilities.layout.initUI(layers);\r\n         }\r\n         else{\r\n           dojo.connect(map,\"onLoad\",function(){\r\n             utilities.layout.initUI(layers);\r\n           });\r\n         }\r\n         //resize the map when the browser resizes\r\n         dojo.connect(dijit.byId('map'), 'resize', map,map.resize);\r\n       });\r\n\r\n       mapDeferred.addErrback(function (error) {\r\n         alert(i18n.viewer.errors.createMap + dojo.toJson(error.message));\r\n       });\r\n\r\n     },\r\n\r\n     initUI: function(layers) {\r\n       //add chrome theme for popup\r\n       dojo.addClass(map.infoWindow.domNode, \"chrome\");\r\n       //add the scalebar\r\n       var scalebar = new esri.dijit.Scalebar({\r\n         map: map,\r\n         scalebarUnit:i18n.viewer.main.scaleBarUnits //metric or english\r\n       });\r\n\r\n       var layerInfo = utilities.layout.buildLayersList(layers);\r\n\r\n       if(layerInfo.length > 0){\r\n         var legendDijit = new esri.dijit.Legend({\r\n           map:map,\r\n           layerInfos:layerInfo\r\n         },\"legendDiv\");\r\n         legendDijit.startup();\r\n       }\r\n       else{\r\n         $(\"#legendToggle\").hide();\r\n       }\r\n     },\r\n\r\n     //build a list of layers to dispaly in the legend\r\n  buildLayersList: function(layers){\r\n\r\n //layers  arg is  response.itemInfo.itemData.operationalLayers;\r\n  var layerInfos = [];\r\n  dojo.forEach(layers, function (mapLayer, index) {\r\n      var layerInfo = {};\r\n      if (mapLayer.featureCollection && mapLayer.type !== \"CSV\") {\r\n        if (mapLayer.featureCollection.showLegend === true) {\r\n            dojo.forEach(mapLayer.featureCollection.layers, function (fcMapLayer) {\r\n              if (fcMapLayer.showLegend !== false) {\r\n                  layerInfo = {\r\n                      \"layer\": fcMapLayer.layerObject,\r\n                      \"title\": mapLayer.title,\r\n                      \"defaultSymbol\": false\r\n                  };\r\n                  if (mapLayer.featureCollection.layers.length > 1) {\r\n                      layerInfo.title += \" - \" + fcMapLayer.layerDefinition.name;\r\n                  }\r\n                  layerInfos.push(layerInfo);\r\n              }\r\n            });\r\n          }\r\n      } else if (mapLayer.showLegend !== false && mapLayer.layerObject) {\r\n      var showDefaultSymbol = false;\r\n      if (mapLayer.layerObject.version < 10.1 && (mapLayer.layerObject instanceof esri.layers.ArcGISDynamicMapServiceLayer || mapLayer.layerObject instanceof esri.layers.ArcGISTiledMapServiceLayer)) {\r\n        showDefaultSymbol = true;\r\n      }\r\n      layerInfo = {\r\n        \"layer\": mapLayer.layerObject,\r\n        \"title\": mapLayer.title,\r\n        \"defaultSymbol\": showDefaultSymbol\r\n      };\r\n        //does it have layers too? If so check to see if showLegend is false\r\n        if (mapLayer.layers) {\r\n            var hideLayers = dojo.map(dojo.filter(mapLayer.layers, function (lyr) {\r\n                return (lyr.showLegend === false);\r\n            }), function (lyr) {\r\n                return lyr.id;\r\n            });\r\n            if (hideLayers.length) {\r\n                layerInfo.hideLayers = hideLayers;\r\n            }\r\n        }\r\n        layerInfos.push(layerInfo);\r\n    }\r\n  });\r\n  return layerInfos;\r\n  },\r\n\r\n  patchID: function() {  //patch id manager for use in apps.arcgis.com\r\n       esri.id._isIdProvider = function(server, resource) {\r\n       // server and resource are assumed one of portal domains\r\n\r\n       var i = -1, j = -1;\r\n\r\n       dojo.forEach(this._gwDomains, function(domain, idx) {\r\n         if (i === -1 && domain.regex.test(server)) {\r\n           i = idx;\r\n         }\r\n         if (j === -1 && domain.regex.test(resource)) {\r\n           j = idx;\r\n         }\r\n       });\r\n\r\n       var retVal = false;\r\n\r\n       if (i > -1 && j > -1) {\r\n         if (i === 0 || i === 4) {\r\n           if (j === 0 || j === 4) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 1) {\r\n           if (j === 1 || j === 2) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 2) {\r\n           if (j === 2) {\r\n             retVal = true;\r\n           }\r\n         }\r\n         else if (i === 3) {\r\n           if (j === 3) {\r\n             retVal = true;\r\n           }\r\n         }\r\n       }\r\n\r\n       return retVal;\r\n     };\r\n    },\r\n\r\n    hideLoader:function(){\r\n      $(\"#loadingCon\").hide();\r\n\t}\r\n\r\n\r\n  });"]],"start1":0,"start2":0,"length1":0,"length2":8832}]],"length":8832}
{"contributors":[],"silentsave":true,"ts":1353092175616,"patch":[[{"diffs":[[0,"ilities."],[-1,"layout"],[1,"main"],[0,"\");\r\n\r\n "]],"start1":18,"start2":18,"length1":22,"length2":20}]],"length":8830,"saved":false}
{"ts":1353092180491,"patch":[[{"diffs":[[0,"ilities."],[-1,"layout"],[1,"ma"],[0," = {};\r\n"]],"start1":564,"start2":564,"length1":22,"length2":18}]],"length":8826,"saved":false}
{"ts":1353092181612,"patch":[[{"diffs":[[0,"ities.ma"],[1,"in"],[0," = {};\r\n"]],"start1":566,"start2":566,"length1":16,"length2":18}]],"length":8828,"saved":false}
{"ts":1353092186600,"patch":[[{"diffs":[[0,"ilities."],[-1,"main"],[1,"layout"],[0," = {};\r\n"]],"start1":564,"start2":564,"length1":20,"length2":22}]],"length":8830,"saved":false}
{"ts":1353092189093,"patch":[[{"diffs":[[0,"ities.ma"],[-1,"in"],[0,"\");\r\n\r\n "]],"start1":20,"start2":20,"length1":18,"length2":16}]],"length":8828,"saved":false}
{"ts":1353092192075,"patch":[[{"diffs":[[0,"ities.ma"],[1,"in"],[0,"\");\r\n\r\n "]],"start1":20,"start2":20,"length1":16,"length2":18}]],"length":8830,"saved":false}
{"ts":1353092196380,"patch":[[{"diffs":[[0,"ilities."],[-1,"layout"],[1,"main"],[0," = {};\r\n"]],"start1":564,"start2":564,"length1":22,"length2":20}]],"length":8828,"saved":false}
{"ts":1353092197812,"patch":[[{"diffs":[[0,"ilities."],[-1,"layout"],[1,"main"],[0,",{\r\n\r\n  "]],"start1":599,"start2":599,"length1":22,"length2":20}]],"length":8826,"saved":false}
